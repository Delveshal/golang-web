<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <link href="index.css" rel="stylesheet" type="text/css"/>
    <title>任务上传</title>
    <script type="text/javascript" src="jq.js"></script>
    <!--上传图片-->
    <script type="text/javascript">
        var pics = [];
        var count = 0;
        $(function(){
            function change(){
                var obj=document.getElementsByClassName("fileBtn")[0];
                var temp="";
                for(var i=0;i<obj.files.length;i++){
                    temp=temp+"<p>"+obj.files[i].name+"<span class='uploadState'>等待上传...</span></p>";
                    $(".filesName").html(temp);
                    uploadFile(obj.files[i],i);
                }
            };
            $(".fileBtn").change(change);
            $(".btn1").click(function () {
                $(".fileBtn").click();
            });
        });
        function uploadFile(file,idx){
            var fd = new FormData();
            fd.append("file",file);
            $.ajax({
                url : '/api/uploadFile',
                type : 'POST',
                //Ajax事件
                beforeSend : function() {
                    document.getElementsByClassName("uploadState")[idx].innerText = "文件上传中...";
                    count++;
                },
                success : function(value) {
                    pics.push(value);
                    document.getElementsByClassName("uploadState")[idx].innerText = "上传成功！";
                    count--;
                },
                error : function() {
                    document.getElementsByClassName("uploadState")[idx].innerText = "上传失败！";
                    count--;
                },
                data : fd,
                cache : false,
                contentType : false,
                processData : false
            });
        }
    </script>
    <!--提交数据-->
    <script type="text/javascript">
        <!--提交表单-->
        function upload() {
            if(pics.length==0){
                alert("请先上传文件！");
                return;
            }
            if(count!==0){
                alert("请等待文件上传完毕！");
                return;
            }
            var es = $(".ct");
            for(var i = 0;i<es.length;i++){
                console.log(es[i]);
                if(es[i].value==""){
                    alert("请先完善信息！");
                    return;
                }
            }
            var formData = new FormData(document.querySelector("#upform"));
            formData.append("pics",pics.join(','));
            var ns = $("input[type=checkbox]");
            var sv = $(".sv");
            var ms = [];
            for(var i =0;i<ns.length;i++){
                if(ns[i].checked){
                    ms.push(sv[i].innerText);
                }
            }
            formData.append("machines",ms.join(','));
            $.ajax({
                url : '/api/upload',
                type : 'POST',
                //Ajax事件
                beforeSend : function(e) {
                    console.log(e);
                },
                success : function(e) {
                    console.log(e);
                    alert("上传成功！");
                    pics = [];
                    var es = $(".ct");
                    for(var i = 0;i<es.length;i++){
                        es[i].value = "";
                    }
                    $(".filesName").html("");
                },
                error : function(e) {
                    console.log(e);
                },
                // Form数据
                data : formData,
                cache : false,
                contentType : false,
                processData : false
            });

        }
    </script>
    <!--设置选择框-->
    <script type="text/javascript">
        var mcs = [];
        window.onload=function () {
            $.ajax({
                url : '/api/machines',
                type : 'GET',
                success : function(value) {
                    var rs = JSON.parse(value);
                    if(!rs.res){
                        alert(rs.msg);
                        return;
                    }
                    mcs = rs.data;
                    appendLabel('-1','全部');
                    for(var i=0;i<mcs.length;i++){
                        appendLabel(i,mcs[i].machine);
                    }
                },
                error : function() {
                    alert("获取机器序列失败！");
                },
            });
        }
        function appendLabel(name,value) {
            var input = document.createElement("input");
            input.setAttribute('type', 'checkbox');
            input.setAttribute('id', "checkbox-7-"+name);  //设置文本为只读类型
            var lable = document.createElement("label");
            lable.setAttribute('for',"checkbox-7-"+name);
            var span = document.createElement("span");
            span.setAttribute('class','sv');
            span.innerText = value;
            lable.appendChild(span);
            var ct = $("#center")[0];
            ct.appendChild(input);
            ct.appendChild(lable);
            input.onclick = function (event) {
                if(event.target.id==='checkbox-7--1'){
                    var ns = $("input[type=checkbox]");
                    for(var i = 0;i<ns.length;i++){
                        ns[i].checked = event.target.checked;
                    }
                    setPonds();
                    return;
                }
                var ns = $("input[type=checkbox]");
                for(var i = 1;i<ns.length;i++){
                    if(ns[i].checked!=ns[0].checked){
                        ns[0].checked=false;
                        setPonds();
                        return;
                    }
                }
                setPonds();
            }
        }
        function setPonds() {
            var ns = $("input[type=checkbox]");
            var sv = $(".sv");
            var ms = new Set([]);
            for(var i =1;i<ns.length;i++){
                if(ns[i].checked){
                    for(var j=0;j<mcs.length;j++){
                        if(sv[i].innerText===mcs[j].machine){
                            var ts = new Set(mcs[j].ponds);
                            if(ms.size!=0)
                                ms = intersection(ms,ts);
                            else
                                ms = ts;
                            break;
                        }
                    }
                }
            }
            var slp = $("#slp")[0];
            slp.innerHTML = "";
            ms.forEach(function (item) {
                var ot = document.createElement("option");
                ot.innerText = item;
                slp.appendChild(ot);
            });
        }
        /**
         * 返回两个集合的交集
         */
        function intersection(thisSet, otherSet) {
            //初始化一个新集合，用于表示交集。
            var interSectionSet = new Set();
            //将当前集合转换为数组
            var values = Array.from(thisSet);
            //遍历数组，如果另外一个集合也有该元素，则interSectionSet加入该元素。
            for (var i = 0; i < values.length; i++) {
                if (otherSet.has(values[i])) {
                    interSectionSet.add(values[i])
                }
            }

            return interSectionSet;
        };
    </script>
</head>
<body>
<div class="wrap">
    <h1 style="color: cornflowerblue;text-align: center">添加任务</h1>
    <!--选择机器-->
    <div style="margin: 20px;"><span>选择机器:</span><div id="center"></div></div>
    <!--信息填写-->
    <form id="upform" method="POST" enctype="multipart/form-data">
        <div style="width: 30%;display: inline-flex;">
            <table>
                <tr><td>商品类型</td><td><input name="type" type="text"></td></tr>
                <tr><td>标题</td><td><input class="ct" name="title" type="text"></td></tr>
                <tr><td>描述</td><td><input class="ct" name="desc" type="text"></td></tr>
                <tr><td>发布地址</td><td><input name="addr" type="text"></td></tr>
                <tr><td>类目名称</td><td><input  name="category" type="text"></td></tr>
                <tr><td>发布到鱼塘</td><td><select name="pond" id="slp"></select></td></tr>
                <tr><td>发布模式</td><td><input name="publicType" type="text"></td></tr>
                <tr><td>原价</td><td><input class="ct" name="rawMoney" type="number"></td></tr>
                <tr><td>价格</td><td><input class="ct" name="money" type="number"></td></tr>
                <tr><td>运费</td><td><input name="tranMoney" type="number"></td></tr>
            </table>
        </div>
        <div style="width: 35%;display: inline-flex;">
            <!--文件上传-->
            <div class="filesName" style="background: #999999; max-height: 300px;margin-top:15px; width: 80%; overflow-y: scroll"></div>
        </div>
    </form>
    <div class="btnBox" style="margin-left: 18%;">
        <input type="file" value="选择文件" class="fileBtn" multiple/>
        <a href="javascript:;" class="btn1">选择文件</a>
        <input type="button" value="提交" class="btn2" onclick="upload()"/>
    </div>
</div>
</body>
</html>